<script>
  const CATEGORY_META = [
    { key:"zboza",     title:"Zboża i oleiste – rynki",           desc:"Pszenica, kukurydza, rzepak, soja/śruta, MATIF/CBOT, Black Sea." },
    { key:"bialko",    title:"Białko paszowe i dodatki",          desc:"Śruty, aminokwasy, witaminy, dodatki – ceny i fundamenty." },
    { key:"indeksy",   title:"Indeksy kosztów pasz / dashboardy", desc:"Indeksy, koszty wytworzenia, portfolio snapshot, feed dashboards." },
    { key:"energia",   title:"Energia",                          desc:"Gaz, prąd, ropa – wpływ na koszty i sentyment." },
    { key:"fx",        title:"FX & Makro",                        desc:"EUR/USD, USD/PLN, EUR/PLN, DXY, stopy, risk-on/off." },
    { key:"specjalne", title:"Raporty specjalne / tematyczne",    desc:"Konferencje, duże opracowania, jednorazowe publikacje." },
    { key:"arch",      title:"Archiwum",                          desc:"Starsze wydania i zestawienia historyczne." }
  ];

  function fmtDatePL(iso){
    if(!iso || typeof iso !== "string") return "—";
    const parts = iso.split("-");
    if(parts.length !== 3) return iso;
    const [y,m,d] = parts;
    return `${d}.${m}.${y}`;
  }

  function parseISO(iso){
    if(!iso || typeof iso !== "string") return -Infinity;
    const t = Date.parse(iso + "T00:00:00Z");
    return isNaN(t) ? -Infinity : t;
  }

  // ===== "jak w porannym skanie": next business day (Mon–Fri) =====
  function parseISODateLocal(iso){
    const p = (iso || "").split("-");
    if(p.length !== 3) return null;
    const y = Number(p[0]), m = Number(p[1]) - 1, d = Number(p[2]);
    const dt = new Date(y, m, d);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function nextBusinessDay(dateObj){
    const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
    do { d.setDate(d.getDate() + 1); } while (d.getDay() === 0 || d.getDay() === 6);
    return d;
  }

  function fmtDatePrettyPL(dt){
    if(!(dt instanceof Date)) return "—";
    return dt.toLocaleDateString("pl-PL", { day:"2-digit", month:"2-digit", year:"numeric" });
  }

  function pickTodayFromScan(scan){
    const items = scan && Array.isArray(scan.items) ? scan.items : [];
    if(!items.length) return null;
    return [...items].sort((a,b)=>parseISO(b.date)-parseISO(a.date))[0] || null;
  }

  async function loadManifest(){
    const url = "manifest.json?ts=" + Date.now();
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("Nie mogę wczytać manifest.json (" + res.status + ")");
    return await res.json();
  }

  async function loadScan(scanBasePath){
    try{
      // scanBasePath np. "raporty/poranny-skan/"
      const base = (scanBasePath || "").replace(/^\/+/, "").replace(/\/?$/, "/");
      const res = await fetch(base + "scan.json?ts=" + Date.now(), { cache:"no-store" });
      if(!res.ok) return null;
      return await res.json();
    }catch(_){
      return null;
    }
  }

  function toItems(manifest){
    return Object.entries(manifest).map(([id, r]) => ({
      id,
      name: r.name || id,
      description: r.description || "",
      path: r.path || ("raporty/" + id + "/"),
      updated: r.updated || "",
      category: (r.category || "").toString().trim().toLowerCase(),
      frequency: (r.frequency || r.freq || "").toString(),
      nextIssue: (r.next_issue || r.nextIssue || r.next || "").toString()
    }));
  }

  function renderFeatured(items, scan){
    const wrap = document.getElementById("featuredWrap");
    const ps = items.find(x => x.id === "poranny-skan");

    if(!ps){
      wrap.innerHTML = `
        <div class="error" style="max-width:820px;width:100%">
          Brak wpisu <code>poranny-skan</code> w <code>manifest.json</code>.
        </div>
      `;
      return;
    }

    const today = pickTodayFromScan(scan);

    // "Aktualizacja: DD.MM.RRRR | HH:MM" jak w porannym skanie
    const updatedISO  = (today && today.date) ? today.date : (ps.updated || "");
    const updatedTime = (today && today.time) ? today.time : "";
    const updatedLabel = updatedISO
      ? (updatedTime ? `${fmtDatePL(updatedISO)} | ${updatedTime}` : fmtDatePL(updatedISO))
      : "—";

    // Kolejne wydanie = następny dzień roboczy od today.date
    let nextTxt = "—";
    if(today && today.date){
      const dt = parseISODateLocal(today.date);
      if(dt){
        nextTxt = fmtDatePrettyPL(nextBusinessDay(dt));
      }
    } else if ((ps.nextIssue || "").trim()){
      nextTxt = fmtDatePL((ps.nextIssue || "").trim());
    }

    const freq = (ps.frequency || "").trim() || "dziennie";

    // linia "na dziś" — bierzemy z dzisiejszego itema (PL lead / title / fallback)
    let todayLine = "";
    if(today && today.pl){
      todayLine = String(today.pl.lead || today.pl.title || "").trim();
    }
    if(!todayLine && today && today.en){
      // awaryjnie jeśli brak PL
      todayLine = String(today.en.lead || today.en.title || "").trim();
    }

    const safePath = (ps.path || "").replace(/^\/+/, "");

    wrap.innerHTML = `
      <a class="featured" href="${safePath}">
        <div class="fMetaLine">
          <span class="badge primary">Poranny skan</span>
          <span><strong>Ostatnia aktualizacja:</strong> ${updatedLabel}</span>
          <span class="badge accent">${freq}</span>
        </div>

        <p class="fTitle">${ps.name}</p>
        ${todayLine ? `<p class="fToday">${todayLine}</p>` : `<p class="fToday">${ps.description}</p>`}

        <div class="fNext">
          <span><strong>Kolejne wydanie:</strong> ${nextTxt}</span>
        </div>
      </a>
    `;
  }

  function renderCategories(items){
    const wrap = document.getElementById("cats");

    const stats = {};
    for(const it of items){
      const k = it.category || "";
      if(!k) continue;
      if(k === "dedyk") continue;
      if(!stats[k]) stats[k] = { count:0, last:"" };
      stats[k].count += 1;
      if(parseISO(it.updated) > parseISO(stats[k].last)) stats[k].last = it.updated;
    }

    wrap.innerHTML = CATEGORY_META.map(c => {
      const s = stats[c.key] || { count:0, last:"" };
      return `
        <a class="cat" href="kategoria.html?cat=${encodeURIComponent(c.key)}">
          <p class="catTitle">${c.title}</p>
          <p class="catDesc">${c.desc}</p>
          <div class="catMeta">
            <span><strong>${s.count}</strong> raportów</span>
            <span>Ostatnia: <strong>${fmtDatePL(s.last)}</strong></span>
          </div>
        </a>
      `;
    }).join("");
  }

  // ===== prices =====
  function arrowCell(n){
    if(n === null || n === undefined || n === "" || Number.isNaN(Number(n))) {
      return { sym:"—", col:"rgba(234,240,255,.70)", txt:"—" };
    }
    const v = Number(n);
    if(v > 0) return { sym:"▲", col:"rgba(125,211,252,.95)", txt:`+${v}` };
    if(v < 0) return { sym:"▼", col:"rgba(255,160,160,.95)", txt:`${v}` };
    return { sym:"—", col:"rgba(234,240,255,.70)", txt:"0" };
  }

  function renderCashTable(rows){
    const tbl = document.getElementById("cashTable");
    const header = `
      <tr>
        <th>Surowiec</th>
        <th class="right">Cena</th>
        <th class="right">Zmiana tyg.</th>
        <th class="right">Zmiana mies.</th>
      </tr>
    `;
    const body = rows.map(r=>{
      const w = arrowCell(r.w);
      const m = arrowCell(r.m);
      return `
        <tr>
          <td>${r.name ?? ""}</td>
          <td class="right" style="font-weight:900">${r.price ?? ""}</td>
          <td class="right" style="color:${w.col}">${w.sym} ${w.txt}</td>
          <td class="right" style="color:${m.col}">${m.sym} ${m.txt}</td>
        </tr>
      `;
    }).join("");
    tbl.innerHTML = header + body;
  }

  function renderFuturesTable(rows){
    const tbl = document.getElementById("futuresTable");
    const header = `
      <tr>
        <th>Instrument</th>
        <th class="right">Close</th>
        <th class="right">Zmiana tyg.</th>
        <th class="right">Zmiana mies.</th>
      </tr>
    `;
    const body = rows.map(r=>{
      const w = arrowCell(r.w);
      const m = arrowCell(r.m);
      return `
        <tr>
          <td>${r.name ?? ""}</td>
          <td class="right" style="font-weight:900">${r.close ?? ""}</td>
          <td class="right" style="color:${w.col}">${w.sym} ${w.txt}</td>
          <td class="right" style="color:${m.col}">${m.sym} ${m.txt}</td>
        </tr>
      `;
    }).join("");
    tbl.innerHTML = header + body;
  }

  async function loadPrices(){
    try{
      const res = await fetch("prices.json?ts=" + Date.now(), { cache:"no-store" });
      if(!res.ok) throw new Error("prices.json (" + res.status + ")");
      const data = await res.json();

      const asof = (data.asof || "—");
      document.getElementById("pricesAsOf").textContent = "Aktualizacja: " + asof;
      document.getElementById("futuresAsOf").innerHTML = "&nbsp;";

      const cashRows = Array.isArray(data.cash) ? data.cash : [];
      const futRows  = Array.isArray(data.futures) ? data.futures : [];

      renderCashTable(cashRows);
      renderFuturesTable(futRows);
    } catch(e){
      const cash = document.getElementById("cashPanel");
      if(cash) cash.innerHTML = `<div class="error">Błąd cennika: ${e.message}</div>`;
      const fut = document.getElementById("futuresPanel");
      if(fut) fut.innerHTML = `<div class="error">Błąd giełd: ${e.message}</div>`;
    }
  }

  (async () => {
    try{
      document.getElementById("asof").textContent =
        "Aktualizacja: " + new Date().toLocaleString("pl-PL");

      const manifest = await loadManifest();
      const items = toItems(manifest);

      const ps = items.find(x => x.id === "poranny-skan");
      const scan = ps ? await loadScan(ps.path) : null;

      renderFeatured(items, scan);
      renderCategories(items);
      loadPrices();
    } catch(e){
      const err = document.getElementById("err");
      err.style.display = "block";
      err.textContent = "Błąd panelu: " + e.message + " (sprawdź Console w DevTools)";
    }
  })();
</script>
