<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ACE ‚Äì Poranny Skan Rynku</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a33;
      --border:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --muted2:rgba(234,240,255,.55);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(125,211,252,.14), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(167,139,250,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px; margin:0 auto; padding:26px 18px 54px}
    header{display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap; margin-bottom:14px}
    .brand{display:flex; gap:14px; align-items:center}
    .logo{
      height:56px;
      width:auto;
      display:block;
      flex:0 0 auto;
      filter: drop-shadow(0 10px 24px rgba(0,0,0,.45));
    }
    h1{margin:0; font-size:24px; letter-spacing:.2px}
    .sub{margin:6px 0 0 0; color:var(--muted); font-size:13px; line-height:1.35}

    .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin:14px 0}
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      padding:8px 10px;
      border-radius:999px;
      color:var(--muted2);
      font-size:12px;
      box-shadow: var(--shadow);
      white-space:nowrap;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      box-shadow: var(--shadow);
      font-size:12px;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn.active{ border-color: rgba(125,211,252,.55); background: rgba(125,211,252,.10); }

    .panel{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .date{color:var(--muted2); font-size:13px; margin-top:4px}

    .lead{margin:12px 0 0 0; font-size:15px; line-height:1.5; color:rgba(234,240,255,.92)}
    .sec{margin-top:18px}
    .sec h2{
      margin:0 0 8px 0; font-size:16px;
      display:flex; align-items:center; gap:10px;
    }
    .icon{
      width:28px; height:28px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      font-size:16px;
      flex:0 0 auto;
    }
    .text{margin:0; color:var(--muted); line-height:1.55; font-size:14px}
    .list{margin:10px 0 0 18px; color:var(--muted); font-size:14px; line-height:1.55}

    /* --- Media layout (60/40) --- */
    .row{
      display:flex;
      gap:14px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .colText{flex: 1 1 60%; min-width: 320px;}
    .colMedia{flex: 1 1 38%; min-width: 260px;}
    .mediaBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:10px;
      box-shadow: var(--shadow);
    }
    .mediaImg{
      width:100%;
      height:auto;
      display:block;
      border-radius:10px;
      cursor: zoom-in;
    }

    .archive{
      margin-top:16px;
      border-top:1px solid rgba(255,255,255,.10);
      padding-top:14px;
    }
    .archive h3{margin:0 0 10px 0; font-size:14px; color:rgba(234,240,255,.9)}
    .archgrid{display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:10px}
    .architem{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:12px;
      cursor:pointer;
      transition: transform .08s ease, border-color .08s ease;
    }
    .architem:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .archmeta{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; color:var(--muted2); font-size:12px; margin-top:6px}

    .footer{
      margin-top:20px;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,.10);
      font-size:12px;
      color:rgba(234,240,255,.55);
    }
    code{background: rgba(255,255,255,.06); padding:2px 6px; border-radius:10px; border:1px solid rgba(255,255,255,.10)}
    .error{
      margin-top:14px;
      border:1px solid rgba(255,120,120,.25);
      background: rgba(255,120,120,.08);
      padding:12px 14px; border-radius:14px; color:rgba(255,220,220,.92);
      box-shadow: var(--shadow);
      font-size:13px;
      white-space:pre-wrap;
    }

    /* Lightbox */
    .lb{
      position:fixed; inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .lb.open{display:flex}
    .lbInner{
      max-width:min(1100px, 96vw);
      max-height:92vh;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(20,25,35,.85);
      box-shadow: 0 20px 80px rgba(0,0,0,.55);
      position:relative;
    }
    .lbImg{
      display:block;
      max-width:100%;
      max-height:92vh;
      height:auto;
      width:auto;
    }
    .lbClose{
      position:absolute;
      top:10px; right:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img src="logo.png" alt="ACE Group" class="logo">
      <div>
        <h1>ACE ‚Äì Poranny Skan Rynku</h1>
        <p class="sub">PL/EN. Archiwum pokazuje ostatnie 10 wpis√≥w (bez dzisiejszego).</p>
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <a class="btn" id="btnHome" href="../../index.html" title="Wr√≥ƒá do panelu">‚Üê Panel g≈Ç√≥wny</a>
      <div class="pill" id="asof">Aktualizacja: ‚Äî</div>
      <div class="pill" id="next">Kolejne wydanie: ‚Äî</div>
    </div>
  </header>

  <div class="topbar">
    <div>
      <button class="btn active" id="btnPL" type="button">PL</button>
      <button class="btn" id="btnEN" type="button">EN</button>
    </div>
    <div class="pill">≈πr√≥d≈Ço: <strong>ACE Group</strong></div>
  </div>

  <section class="panel" id="main"></section>
  <div id="err" class="error" style="display:none"></div>

  <section class="panel archive" id="archive"></section>

  <div class="footer">
    To nie jest porada inwestycyjna. <code>Agri Commodity Experts Sp. z o.o.</code>
  </div>
</div>

<!-- Lightbox -->
<div class="lb" id="lb">
  <div class="lbInner">
    <button class="lbClose" id="lbClose">Zamknij ‚úï</button>
    <img class="lbImg" id="lbImg" alt="">
  </div>
</div>

<script>
  const DATA_URL = "scan.json?ts=" + Date.now();
  let LANG = "pl";
  let ITEMS = [];
  let ACTIVE_ID = null;

  function setLang(lang){
    LANG = lang;
    document.getElementById("btnPL").classList.toggle("active", lang==="pl");
    document.getElementById("btnEN").classList.toggle("active", lang==="en");
    updateHeaderFromToday();
    render();
  }

  function fmtDate(iso){
    if(!iso) return "‚Äî";
    const p = iso.split("-");
    if(p.length!==3) return iso;
    return (LANG==="pl") ? `${p[2]}.${p[1]}.${p[0]}` : `${p[0]}-${p[1]}-${p[2]}`;
  }

  function esc(s){
    return (s||"").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function parseISODate(iso){
    const p = (iso||"").split("-");
    if(p.length!==3) return null;
    const y = Number(p[0]), m = Number(p[1])-1, d = Number(p[2]);
    const dt = new Date(y, m, d);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function nextBusinessDay(dateObj){
    const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
    do { d.setDate(d.getDate() + 1); } while (d.getDay() === 0 || d.getDay() === 6);
    return d;
  }

  function fmtDatePretty(dt){
    if(!(dt instanceof Date)) return "‚Äî";
    if(LANG==="pl"){
      return dt.toLocaleDateString("pl-PL", { day:"2-digit", month:"2-digit", year:"numeric" });
    }
    return dt.toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });
  }

  function isNonEmptyText(x){ return (x||"").toString().trim().length > 0; }
  function isNonEmptyArray(a){ return Array.isArray(a) && a.some(x => (x||"").toString().trim().length>0); }

  function openLightbox(src){
    const lb = document.getElementById("lb");
    const img = document.getElementById("lbImg");
    img.src = src;
    lb.classList.add("open");
  }
  function closeLightbox(){
    const lb = document.getElementById("lb");
    const img = document.getElementById("lbImg");
    lb.classList.remove("open");
    img.src = "";
  }
  document.getElementById("lbClose").onclick = closeLightbox;
  document.getElementById("lb").addEventListener("click",(e)=>{
    if(e.target && e.target.id==="lb") closeLightbox();
  });

  function renderMedia(media){
    const m = Array.isArray(media) ? media : [];
    const img = m.find(x => x && x.type==="image" && isNonEmptyText(x.src));
    if(!img) return "";
    const src = img.src;
    return `
      <div class="mediaBox">
        <img class="mediaImg" src="${esc(src)}" alt="" data-lb="${esc(src)}">
      </div>
    `;
  }

  function section(icon, title, text, media){
    const hasIcon = isNonEmptyText(icon);
    const mediaHtml = renderMedia(media);
    const textHtml = isNonEmptyText(text) ? `<p class="text">${esc(text)}</p>` : `<p class="text">‚Äî</p>`;

    if(mediaHtml){
      return `
        <div class="sec">
          <h2>${hasIcon ? `<span class="icon">${esc(icon)}</span>` : ``}${esc(title)}</h2>
          <div class="row">
            <div class="colText">${textHtml}</div>
            <div class="colMedia">${mediaHtml}</div>
          </div>
        </div>
      `;
    }

    return `
      <div class="sec">
        <h2>${hasIcon ? `<span class="icon">${esc(icon)}</span>` : ``}${esc(title)}</h2>
        ${textHtml}
      </div>
    `;
  }

  // --- wa≈ºne: tu wycinamy blok "Kr√≥tki wstƒôp do dnia" (duplikat lead)
  function isIntroTitle(t){
    const x = (t||"").toString().trim().toLowerCase();
    return [
      "tytu≈Ç","wprowadzenie","co dzi≈õ wa≈ºnego ?","co dzi≈õ wa≈ºnego",
      "kr√≥tki wstƒôp do dnia","kr√≥tki wstƒôp do dnia:"
    ].includes(x);
  }

  function renderBlocksFromDynamic(item, t){
    const blocks = Array.isArray(t.blocks) ? t.blocks : [];
    if(!blocks.length) return "";

    const pageTitle = (t.title || "").toString().trim();
    const pageLead  = (t.lead  || "").toString().trim();

    let html = "";
    for (const b of blocks){
      const title = (b?.title || "").toString().trim();
      const text  = (b?.text  || "").toString().trim();
      const icon  = (b?.icon  || "").toString().trim();
      const media = b?.media;

      if(!isNonEmptyText(title) || !isNonEmptyText(text)) continue;

      // usu≈Ñ blok wstƒôpowy, je≈õli dubluje lead
      if(isIntroTitle(title) && text === pageLead) continue;

      // usu≈Ñ sztuczne "Tytu≈Ç" je≈õli kto≈õ to trzyma w blokach
      if(isIntroTitle(title) && text === pageTitle) continue;

      html += section(icon, title, text, media);
    }
    return html;
  }

  function renderMain(item){
    const t = item[LANG] || {};
    const dateLine = `${fmtDate(item.date)} | ${item.time || "‚Äî"}`;
    const title = t.title || (LANG==="pl" ? "ACE ‚Äì Poranny Skan Rynku" : "ACE ‚Äì Morning Market Scan");
    const lead = (t.lead||"").trim();

    // lead + media obok (je≈õli jest lead_media)
    const leadMediaHtml = renderMedia(t.lead_media);
    const leadBlock = isNonEmptyText(lead)
      ? (leadMediaHtml
        ? `<div class="row" style="margin-top:12px">
             <div class="colText"><p class="lead">${esc(lead)}</p></div>
             <div class="colMedia">${leadMediaHtml}</div>
           </div>`
        : `<p class="lead">${esc(lead)}</p>`)
      : "";

    let blocksHtml = renderBlocksFromDynamic(item, t);

    // fallback (gdy nie ma blocks)
    if(!blocksHtml){
      const fx = (t.fx||"").trim();
      const agri = (t.agri||"").trim();
      const focus = Array.isArray(t.focus) ? t.focus.filter(x => isNonEmptyText(x)) : [];

      if(isNonEmptyText(agri)){
        blocksHtml += section("üåæ", (LANG==="pl"?"Zbo≈ºa i oleiste":"Grains & Oilseeds"), agri, null);
      }
      if(isNonEmptyText(fx)){
        blocksHtml += section("üíµ", (LANG==="pl"?"FX / Makro":"FX / Macro"), fx, null);
      }
      if(isNonEmptyArray(focus)){
        blocksHtml += `
          <div class="sec">
            <h2><span class="icon">üéØ</span>${LANG==="pl"?"Na co zwr√≥ciƒá uwagƒô dzi≈õ":"What to watch"}</h2>
            <ul class="list">${focus.map(x=>`<li>${esc(x)}</li>`).join("")}</ul>
          </div>
        `;
      }
    }

    if(!blocksHtml) blocksHtml = `<p class="text">‚Äî</p>`;

    document.getElementById("main").innerHTML = `
      <div>
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap">
          <div>
            <div style="font-weight:700; font-size:18px">${esc(title)}</div>
            <div class="date">${esc(dateLine)}</div>
          </div>
          <div class="pill">ID: <strong>${esc(item.id)}</strong></div>
        </div>

        ${leadBlock}
        ${blocksHtml}
      </div>
    `;

    // bind lightbox clicks
    document.querySelectorAll("[data-lb]").forEach(el=>{
      el.onclick = ()=>openLightbox(el.getAttribute("data-lb"));
    });
  }

  function renderArchive(){
    const box = document.getElementById("archive");
    const t = (LANG==="pl")
      ? {h:"Archiwum (ostatnie 10 ‚Äì bez dzisiejszego)", open:"Otw√≥rz", empty:"Brak archiwum.", today:"DZI≈ö"}
      : {h:"Archive (last 10 ‚Äì excluding today)", open:"Open", empty:"No archive yet.", today:"TODAY"};

    const today = ITEMS[0] || null;
    const todayId = today ? today.id : null;

    const archItems = ITEMS
      .slice(1)
      .filter(x => x && x.id !== todayId)
      .slice(0, 10);

    const todayTile = today ? `
      <div class="architem" data-id="${esc(today.id)}" data-today="1">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
          <div style="font-weight:700">${esc((today[LANG]||{}).title || (LANG==="pl"?"Poranny Skan":"Morning Scan"))}</div>
          <div class="pill" style="padding:4px 8px; font-size:11px; box-shadow:none; background: rgba(125,211,252,.10); border-color: rgba(125,211,252,.35); color: rgba(234,240,255,.9)">
            ${t.today}
          </div>
        </div>
        <div class="archmeta">
          <span>${fmtDate(today.date)} | ${today.time || "‚Äî"}</span>
          <span>${t.open} ‚Üí</span>
        </div>
      </div>
    ` : "";

    box.innerHTML = `
      <h3>${t.h}</h3>
      ${todayTile}
      ${archItems.length ? `
        <div class="archgrid" style="margin-top:10px">
          ${archItems.map(it => {
            const tt = it[LANG] || {};
            return `
              <div class="architem" data-id="${esc(it.id)}">
                <div style="font-weight:700">${esc(tt.title || (LANG==="pl"?"Poranny Skan":"Morning Scan"))}</div>
                <div class="archmeta">
                  <span>${fmtDate(it.date)} | ${it.time || "‚Äî"}</span>
                  <span>${t.open} ‚Üí</span>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      ` : `<p class="text">${t.empty}</p>`}
    `;

    box.querySelectorAll(".architem").forEach(el=>{
      el.addEventListener("click",()=>{
        ACTIVE_ID = el.dataset.id;
        render();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });
  }

  function render(){
    const current = ITEMS.find(x => x.id === ACTIVE_ID) || ITEMS[0];
    if(!current) return;
    ACTIVE_ID = current.id;
    renderMain(current);
    renderArchive();
  }

  function updateHeaderFromToday(){
    const today = ITEMS[0];

    if(!today){
      document.getElementById("asof").textContent = (LANG==="pl") ? "Aktualizacja: ‚Äî" : "Updated: ‚Äî";
      document.getElementById("next").textContent = (LANG==="pl") ? "Kolejne wydanie: ‚Äî" : "Next edition: ‚Äî";
      return;
    }

    document.getElementById("asof").textContent =
      (LANG==="pl")
        ? `Aktualizacja: ${fmtDate(today.date)} | ${today.time || "‚Äî"}`
        : `Updated: ${today.date || "‚Äî"} | ${today.time || "‚Äî"}`;

    const dt = parseISODate(today.date);
    if(dt){
      const nxt = nextBusinessDay(dt);
      document.getElementById("next").textContent =
        (LANG==="pl") ? `Kolejne wydanie: ${fmtDatePretty(nxt)}` : `Next edition: ${fmtDatePretty(nxt)}`;
    } else {
      document.getElementById("next").textContent =
        (LANG==="pl") ? "Kolejne wydanie: ‚Äî" : "Next edition: ‚Äî";
    }
  }

  function hasEN(item){
    const en = item && item.en;
    if(!en) return false;
    const anyText = (en.title||"").trim() || (en.lead||"").trim() || (en.fx||"").trim() || (en.agri||"").trim();
    const anyBlocks = Array.isArray(en.blocks) && en.blocks.some(b => (b?.title||"").trim() && (b?.text||"").trim());
    return !!(anyText || anyBlocks);
  }

  async function init(){
    try{
      const res = await fetch(DATA_URL, {cache:"no-store"});
      if(!res.ok) throw new Error("Nie mogƒô wczytaƒá scan.json");
      const data = await res.json();
      ITEMS = Array.isArray(data.items) ? data.items : [];

      // je≈õli dzisiejszy wpis nie ma EN ‚Üí ukryj przycisk
      const btnEN = document.getElementById("btnEN");
      if(ITEMS[0] && !hasEN(ITEMS[0])){
        btnEN.style.display = "none";
      } else {
        btnEN.style.display = "";
      }

      updateHeaderFromToday();
      render();
    } catch(e){
      const err = document.getElementById("err");
      err.style.display = "block";
      err.textContent = "B≈ÇƒÖd: " + (e && e.message ? e.message : e);
    }
  }

  document.getElementById("btnPL").onclick = ()=>setLang("pl");
  document.getElementById("btnEN").onclick = ()=>setLang("en");
  init();
</script>
</body>
</html>
